# =============================================================================
# Mault Governance Gate — Step 7: Advanced Detection
# =============================================================================
# Aggregates all governance layers into a single pass/fail status.
# Required check name (case-sensitive): "Governance Gate Summary"
# =============================================================================

name: Mault Governance Gate

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"

jobs:
  # ---------------------------------------------------------------------------
  # Governance Gate Summary
  # Aggregates all governance layers — this is the required check name.
  # ---------------------------------------------------------------------------
  governance-gate-summary:
    name: Governance Gate Summary
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dev dependencies
        run: pip install -r requirements-dev.txt

      - name: Layer 1 — Mock Tax check
        run: python scripts/governance/check_mock_tax.py

      - name: Layer 2 — Type Safety gate
        run: python scripts/governance/check_type_safety.py

      - name: Layer 3 — Coverage Ratchet
        run: python scripts/governance/check_coverage_ratchet.py

      - name: Layer 4 — Integration Test Pairing
        run: python scripts/governance/check_integration_pairing.py

      - name: Validate rulebook (mault.yaml)
        run: |
          python3 -c "
          import sys, yaml
          try:
              data = yaml.safe_load(open('docs/mault.yaml'))
              assert 'version' in data, 'Missing version key'
              assert 'Detectors' in data, 'Missing Detectors key'
              assert 'deprecatedPatterns' in data, 'Missing deprecatedPatterns key'
              assert 'rules' in data, 'Missing rules key (UC18)'
              assert 'monolithDetection' in data, 'Missing monolithDetection (UC14)'
              print('PASS: docs/mault.yaml is valid and complete')
          except Exception as e:
              print(f'FAIL: {e}')
              sys.exit(1)
          "
