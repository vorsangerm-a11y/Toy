version: 1

# =============================================================================
# UC02: LEGACY PATH PREVENTION
# =============================================================================
# Detect deprecated imports and function calls that should no longer be used.

deprecatedPatterns:
  # ----- Python 2/3 Migration -----
  - id: dep-optparse
    import: optparse
    message: "optparse is deprecated since Python 2.7. Use 'argparse' instead."
    languages: [python]

  - id: dep-urllib2
    import: urllib2
    message: "urllib2 is Python 2 only. Use 'urllib.request' instead."
    languages: [python]

  - id: dep-httplib
    import: httplib
    message: "httplib is Python 2 only. Use 'http.client' instead."
    languages: [python]

  - id: dep-imp
    import: imp
    message: "imp module is deprecated since Python 3.4. Use 'importlib' instead."
    languages: [python]

  - id: dep-cgi
    import: cgi
    message: "cgi module is deprecated since Python 3.11. Use modern web frameworks."
    languages: [python]

  - id: dep-crypt
    import: crypt
    message: "crypt module is deprecated since Python 3.11. Use 'passlib' instead."
    languages: [python]

  - id: dep-pipes
    import: pipes
    message: "pipes module is deprecated since Python 3.11. Use 'subprocess' instead."
    languages: [python]

  - id: dep-getopt
    import: getopt
    message: "getopt is legacy. Use 'argparse' or 'click' instead."
    languages: [python]

  - id: dep-distutils
    import: distutils
    message: "distutils is deprecated since Python 3.10. Use 'setuptools' instead."
    languages: [python]

  - id: dep-pkg-resources
    import: pkg_resources
    message: "pkg_resources is deprecated. Use 'importlib.metadata' instead."
    languages: [python]

  # ----- Deprecated Functions -----
  - id: dep-os-popen
    functionCall: os.popen
    message: "os.popen is deprecated. Use 'subprocess.run()' instead."
    languages: [python]

  - id: dep-os-system
    functionCall: os.system
    message: "os.system is deprecated. Use 'subprocess.run()' instead."
    languages: [python]

  # ----- Security Deprecations -----
  - id: dep-md5
    functionCall: hashlib.md5
    message: "MD5 is cryptographically broken. Use 'hashlib.sha256' for security."
    languages: [python]

  - id: dep-sha1
    functionCall: hashlib.sha1
    message: "SHA1 is deprecated for security. Use 'hashlib.sha256' instead."
    languages: [python]

  - id: dep-random-security
    functionCall: random.random
    message: "random module is not cryptographically secure. Use 'secrets' for security."
    languages: [python]

  # ----- Library Deprecations -----
  - id: dep-nose
    import: nose
    message: "nose is deprecated. Migrate to 'pytest' instead."
    languages: [python]

  - id: dep-mock
    import: mock
    message: "mock library is deprecated. Use 'unittest.mock' instead."
    languages: [python]

# =============================================================================
# DETECTORS CONFIGURATION (Core UCs: UC01-UC12)
# =============================================================================

Detectors:
  # UC01: Directory Reinforcement
  # Flags files that are placed in the wrong directory based on their name.
  directoryReinforcement:
    enabled: true
    rules:
      # Service files
      - pattern: "**/*_service.py"
        expectedDir: "src/services"
        reason: "Service files should be in src/services/"

      # Repository/DAO files
      - pattern: "**/*_repository.py"
        expectedDir: "src/repositories"
        reason: "Repository files should be in src/repositories/"
      - pattern: "**/*_dao.py"
        expectedDir: "src/repositories"
        reason: "DAO files should be in src/repositories/"

      # Utility files
      - pattern: "**/*_util*.py"
        expectedDir: "src/utils"
        reason: "Utility files should be in src/utils/"
      - pattern: "**/*_helper*.py"
        expectedDir: "src/utils"
        reason: "Helper files should be in src/utils/"
      - pattern: "**/utils_*.py"
        expectedDir: "src/utils"
        reason: "Utility files should be in src/utils/"

      # Model files
      - pattern: "**/*_model.py"
        expectedDir: "src/models"
        reason: "Model files should be in src/models/"

      # Test files
      - pattern: "**/test_*.py"
        expectedDir: "tests"
        reason: "Test files should be in tests/"
      - pattern: "**/*_test.py"
        expectedDir: "tests"
        reason: "Test files should be in tests/"

      # Configuration files
      - pattern: "**/config*.py"
        expectedDir: "src/config"
        reason: "Configuration files should be in src/config/"
      - pattern: "**/settings*.py"
        expectedDir: "src/config"
        reason: "Settings files should be in src/config/"

  # UC03: Naming Convention
  # Flags files and code that don't follow snake_case / PascalCase rules.
  namingConvention:
    enabled: true
    fileNaming: "snake_case"
    excludePatterns:
      - "**/conftest.py"
      - "**/__init__.py"
      - "**/*.config.*"
      - "**/Makefile"
      - "**/Dockerfile"
      - "**/Pipfile"
    variableNaming: "snake_case"
    functionNaming: "snake_case"
    classNaming: "PascalCase"
    constantNaming: "SCREAMING_SNAKE_CASE"

  # UC04: Environment Reinforcement
  # Warns when hardcoded paths or commands differ from the declared environment.
  environmentReinforcement:
    enabled: true
    checkPaths: true
    checkCommands: true

  # UC06: Temporary Files
  # Flags scratch files, backups, and temp files that should not be committed.
  tempFiles:
    enabled: true
    patterns:
      - "**/*.tmp"
      - "**/temp_*"
      - "**/temp-*"
      - "**/temp.*"
      - "**/scratch_*"
      - "**/scratch-*"
      - "**/scratch.*"
      - "**/scratchpad.*"
      - "**/*.bak"
      - "**/*_backup.*"
      - "**/*-backup.*"
      - "**/*_old.*"
      - "**/*-old.*"
      - "**/*.backup"
      - "**/debug_*"
      - "**/debug-*"
      - "**/debug.*"
      - "**/.ipynb_checkpoints/**"
      - "**/*.pyc"
      - "**/*.pyo"

  # UC07: Flat Architecture
  # Warns when source directories lack enough sub-structure.
  flatArchitecture:
    enabled: true
    targets:
      - path: "src"
        maxRootFiles: 10
        minSubdirs: 3
        excludePatterns: ["__pycache__/**", "*.egg-info/**"]
      - path: "."
        maxRootFiles: 20
        excludePatterns: ["venv/**", ".venv/**", "__pycache__/**", ".git/**", "dist/**"]

  # UC08: Configuration Chaos
  # Ensures required config files are present at the project root.
  configChaos:
    enabled: true
    requiredConfigs:
      - ".gitignore"
      - "requirements.txt"
    optionalConfigs:
      - "pyproject.toml"
      - ".env.example"
      - "Dockerfile"
      - "docker-compose.yml"
      - "pytest.ini"
      - "mypy.ini"

  # UC09: File Proliferation
  # Flags versioned filenames like utils_v1.py, helpers_old2.py.
  fileProliferation:
    enabled: true
    threshold: 3

  # UC11: Overcrowded Folders
  # Warns when a directory contains too many files.
  overcrowdedFolders:
    enabled: true
    targets:
      - path: "src"
        maxFiles: 20
      - path: "src/utils"
        maxFiles: 15
      - path: "src/services"
        maxFiles: 20
      - path: "src/models"
        maxFiles: 25
      - path: "tests"
        maxFiles: 30

  # UC12: Misplaced Utilities
  # Flags utility/helper functions defined outside the central utils directory.
  misplacedUtilities:
    enabled: true
    centralLocation: "src/utils"

  # Project Scaffolding (informational)
  # Tracks whether key scaffold files are present.
  projectScaffolding:
    enabled: true
    rootMaxFiles: 20

  # Dead End Directories (informational)
  # Detects empty or nearly-empty directories that serve no purpose.
  deadEnds:
    enabled: true
    ignoreGlobs: ["**/venv/**", "**/.venv/**", "**/__pycache__/**", "**/.git/**"]
    maxFiles: 500
    timeBudgetMs: 5000

  # UC16: Dependency Health (Pro)
  # Scans for vulnerable packages using pip-audit / npm audit.
  dependencyHealth:
    enabled: true
    severityThreshold: "moderate"

  # UC17: Architecture Diagrams (Pro)
  # Generates Mermaid dependency graphs from imports.
  productionReadiness:
    enabled: true

# =============================================================================
# UC13: APPLICATION FLOW ANALYSIS
# =============================================================================
# Maps files to business flows and tracks high-impact dependencies.

applicationFlows:
  - id: authentication
    name: "Authentication Flow"
    description: "User login, logout, session, and token management"

  - id: data-access
    name: "Data Access Layer"
    description: "Database connections, ORM, and repository operations"

  - id: api-core
    name: "API Core"
    description: "Main API endpoints, routing, and request handling"

  - id: business-logic
    name: "Business Logic"
    description: "Core business rules and domain services"

flows:
  authentication:
    name: "Authentication Flow"
    description: "User authentication, authorization, and session management"
    critical: true
    files:
      - "**/auth*.py"
      - "**/login*.py"
      - "**/session*.py"
      - "**/token*.py"
      - "**/middleware/auth*.py"

  data-access:
    name: "Data Access Layer"
    description: "Database and ORM operations"
    critical: true
    files:
      - "**/db*.py"
      - "**/database*.py"
      - "**/repository*.py"
      - "**/models/**/*.py"

  api-core:
    name: "API Core"
    description: "Main API routing and handlers"
    critical: true
    files:
      - "**/api*.py"
      - "**/routes*.py"
      - "**/views*.py"
      - "**/endpoints*.py"

  business-logic:
    name: "Business Logic"
    description: "Core business rules and domain services"
    critical: true
    files:
      - "**/services/**/*.py"
      - "**/domain/**/*.py"

applicationFlowBlindness:
  enabled: true
  thresholds:
    warnOnDirectDependents: 5
    warnOnTransitiveDependents: 15
  excludePatterns:
    - "**/venv/**"
    - "**/.venv/**"
    - "**/__pycache__/**"
    - "**/test_*.py"
    - "**/*_test.py"
    - "**/tests/**"
    - "**/.pytest_cache/**"

# =============================================================================
# UC14: MONOLITH DETECTION
# =============================================================================
# Alerts when files or functions exceed LOC thresholds.

monolithDetection:
  enabled: true
  thresholds:
    sourceWarnLoc: 750
    sourceFailLoc: 1500
    testWarnLoc: 1500
    testFailLoc: 3000
    maxFunctionLoc: 100
  excludePatterns: []

# =============================================================================
# TEST PYRAMID DETECTOR (Pro)
# =============================================================================
# Configures which files the Test Pyramid Detector scans for missing tests,
# layer compliance, and Mock Tax enforcement.

testPyramid:
  enabled: true
  sourcePatterns:
    - "src/**/*.py"
  excludePatterns:
    - "**/venv/**"
    - "**/.venv/**"
    - "**/__pycache__/**"
    - "**/test_*.py"
    - "**/*_test.py"
    - "**/conftest.py"
    - "**/__init__.py"
  testPatterns:
    - "tests/test_*.py"
    - "tests/**/test_*.py"

# =============================================================================
# UC18: STRUCTURAL GOVERNANCE (Pro)
# =============================================================================
# rules must be at top-level (not nested under Detectors).
# Assertion types: export_exists, function_signature, import_exists,
#                  ast_skeleton, forbidden_pattern, semantic_similarity

rules:
  # No print() in production code
  - id: LOG-001
    name: "No Print Statements"
    severity: warning
    files: "src/**/*.py"
    description: "Use logging module instead of print()"
    assertions:
      - type: forbidden_pattern
        pattern: "print\\s*\\("
        message: "Use logging module instead of print()"

  # No debug breakpoints
  - id: DEBUG-001
    name: "No Breakpoints"
    severity: error
    files: "**/*.py"
    description: "Remove breakpoint() and pdb before committing"
    assertions:
      - type: forbidden_pattern
        pattern: "breakpoint\\s*\\(|import\\s+pdb|pdb\\.set_trace"
        message: "Remove debug breakpoints before committing"

  # No focused tests
  - id: TEST-001
    name: "No Focused Tests"
    severity: error
    files: "tests/**/*.py"
    description: "Prevent committing focused tests"
    assertions:
      - type: forbidden_pattern
        pattern: "@pytest\\.mark\\.only|@only"
        message: "Remove focused test markers before committing"

  # No bare except
  - id: ERR-001
    name: "No Bare Except"
    severity: warning
    files: "**/*.py"
    description: "Avoid bare except clauses"
    assertions:
      - type: forbidden_pattern
        pattern: "except\\s*:"
        message: "Use specific exception types instead of bare except"

  # No wildcard imports
  - id: IMPORT-001
    name: "No Wildcard Imports"
    severity: warning
    files: "**/*.py"
    description: "Avoid wildcard imports"
    assertions:
      - type: forbidden_pattern
        pattern: "from\\s+\\w+\\s+import\\s+\\*"
        message: "Use explicit imports instead of wildcard imports"
